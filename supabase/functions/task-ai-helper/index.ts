import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const body = await req.json();
    const { taskDescription, taskCategory, conversationHistory, startTime, type, messages } = body;
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");

    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // Deeply AI Chat
    if (type === "deeply-chat" && messages) {
      const deeplySystem = `××ª×” ××××Ÿ ×¤×¨×•×“×•×§×˜×™×‘×™×•×ª ×•×¨×™×›×•×– ××§×¦×•×¢×™. ××ª×” ××ª××—×” ×‘×©×™×˜×•×ª ×¢×‘×•×“×” ×¢××•×§×” (Deep Work), ×¤×•××•×“×•×¨×•, Flow State, Atomic Habits, ×•××•×˜×™×‘×¦×™×”.
×‘×¡×™×¡ ×”×™×“×¢ ×©×œ×š ×›×•×œ×œ ××¢×œ 100 ×¡×¤×¨×™ ×¤×¨×•×“×•×§×˜×™×‘×™×•×ª: Deep Work (×§×œ × ×™×•×¤×•×¨×˜), Atomic Habits (×’'×™×™××¡ ×§×œ×™×¨), The War of Art, Flow (×¦'×™×§×¡× ×˜××™×”××™), GTD, Eat That Frog, Indistractable, Make Time, Peak Performance, The Compound Effect ×•×¢×•×“.
×ª×Ÿ ×¢×¦×•×ª ××¢×©×™×•×ª, ×§×¦×¨×•×ª ×•×××•×§×“×•×ª. ×“×‘×¨ ×‘×¢×‘×¨×™×ª. ×”×©×ª××© ×‘××™××•×’'×™×. ×”×™×” ××¢×•×“×“ ×•×× ×¨×’×˜×™.`;

      const aiResponse = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
        method: "POST",
        headers: { Authorization: `Bearer ${LOVABLE_API_KEY}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "google/gemini-2.5-pro",
          messages: [{ role: "system", content: deeplySystem }, ...messages],
        }),
      });

      if (!aiResponse.ok) {
        const errText = await aiResponse.text();
        console.error("AI error:", aiResponse.status, errText);
        throw new Error("AI gateway error");
      }

      const aiData = await aiResponse.json();
      const reply = aiData.choices?.[0]?.message?.content || "××™×Ÿ ×ª×©×•×‘×”";
      return new Response(JSON.stringify({ reply }), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
    }




    let systemPrompt: string;
    let userPrompt: string;

    if (taskCategory?.startsWith('daily_planning')) {
      systemPrompt = `××ª×” ××ª×›× ×Ÿ ×™×•× ××™×©×™ ××§×¦×•×¢×™ ×•×× ×•×¡×”. ××ª×” ××‘×™×Ÿ ×¢×‘×¨×™×ª ×•×¢×•×‘×“ ×œ×¤×™ ×©×¢×•×Ÿ ×™×©×¨××œ×™ (×¤×•×¨××˜ 24 ×©×¢×•×ª).

×›×œ×œ×™× ×§×¨×™×˜×™×™× ×œ×©×¢×•×ª:
1. ×›×©×”××©×ª××© × ×•×ª×Ÿ ×©×¢×ª ×”×ª×—×œ×” (×œ××©×œ "14:00" ××• "14 ×‘×¦×”×¨×™×™×") - ×—×™×™×‘ ×œ×”×ª×—×™×œ ×‘×“×™×•×§ ×××•×ª×” ×©×¢×”!
2. ×× × ×××¨ "×¢×›×©×™×• 14:00" - ×”×œ×•"×– ××ª×—×™×œ ×‘-14:00 ×‘×“×™×•×§, ×œ× ×××•×—×¨ ×™×•×ª×¨
3. ×× × ×××¨ "19 ×‘×¢×¨×‘" ××• "19:00" - ×–×• ×”×©×¢×” 19:00 ×‘×“×™×•×§
4. ×ª××™×“ ×”×©×ª××© ×‘×¤×•×¨××˜ ×©×¢×•×Ÿ 24 ×©×¢×•×ª (07:00, 14:30, 19:00 ×•×›×•')

×¤×•×¨××˜ ×”×œ×•"×– (×—×•×‘×” ×œ×”×©×ª××© ×‘×˜×‘×œ×ª Markdown):
| ×©×¢×” | ××©×™××” | ××©×š | ×”×¢×¨×•×ª |
|-----|--------|-----|-------|
| 14:00 | ××©×™××” 1 | 30 ×“×§' | ×¤×¨×˜×™× |
| 14:30 | ××©×™××” 2 | 45 ×“×§' | ×¤×¨×˜×™× |

×¢×§×¨×•× ×•×ª ×ª×›× ×•×Ÿ ×—×›×:
- ××©×™××•×ª ×“×—×•×¤×•×ª ×•×‘××™×—×•×¨ - ×ª×¢×“×•×£ ×¨××©×•×Ÿ!
- ××©×™××•×ª ×©×“×•×¨×©×•×ª ×¨×™×›×•×– ×’×‘×•×” - ×‘×©×¢×•×ª ×”×‘×•×§×¨/×¦×”×¨×™×™×
- ×”×¤×¡×§×•×ª ×§×¦×¨×•×ª (5-10 ×“×§') ×›×œ ×©×¢×”-×©×¢×ª×™×™×
- ××¨×•×—×•×ª ×•×× ×•×—×” - ××œ ×ª×“×œ×’ ×¢×œ×™×”×Ÿ
- ××œ ×ª×“×—×•×¡ ×™×•×ª×¨ ××“×™ - ×”×™×” ×¨×™××œ×™×¡×˜×™
- ×ª×Ÿ ×”××œ×¦×•×ª ×•×ª×•×‘× ×•×ª ×‘×¡×•×£ ×”×˜×‘×œ×”

×”××œ×¦×•×ª ×©×›×“××™ ×œ×”×•×¡×™×£:
- ×˜×›× ×™×§×•×ª ×¤×¨×•×“×•×§×˜×™×‘×™×•×ª (×¤×•××•×“×•×¨×•, time blocking)
- ×”×¦×¢×•×ª ×œ×¡×“×¨ ×‘×™×¦×•×¢ ××•×¤×˜×™××œ×™
- ××–×”×¨×•×ª ×× ×™×© ×¢×•××¡ ×™×ª×¨
- ×”×¦×¢×•×ª ×œ×”×¤×¡×§×•×ª ××§×˜×™×‘×™×•×ª`;

      const startTimeStr = startTime || "×¢×›×©×™×•";
      userPrompt = taskCategory === 'daily_planning_feedback' 
        ? taskDescription 
        : `×©×¢×ª ×”×ª×—×œ×”: ${startTimeStr}

×¨×©×™××ª ×”××©×™××•×ª ×”×¤×ª×•×—×•×ª ×©×œ×™:
${taskDescription}

×¦×•×¨ ×œ×•"×– ×™×•××™ ××¡×•×“×¨ ×‘×˜×‘×œ×ª Markdown.
×”×ª×—×œ ×‘×“×™×•×§ ××”×©×¢×” ${startTimeStr}.
×‘×¡×•×£ ×”×˜×‘×œ×”, ×”×•×¡×£ ×”××œ×¦×•×ª ×•×ª×•×‘× ×•×ª ×œ×¤×¨×•×“×•×§×˜×™×‘×™×•×ª.`;

    } else if (taskCategory === 'mental_coaching') {
      systemPrompt = `××ª×” ××××Ÿ ×× ×˜×œ×™ ×—×, ×××¤×ª×™ ×•××§×¦×•×¢×™. ××ª×” ×¢×•×–×¨ ×œ×× ×©×™× ×œ×”×ª×’×‘×¨ ×¢×œ ×—×¡××™× ×× ×˜×œ×™×™× ×©××•× ×¢×™× ××”× ×œ×‘×¦×¢ ××©×™××•×ª.

×”×’×™×©×” ×©×œ×š ××‘×•×¡×¡×ª ×¢×œ ××™×˜×‘ ×”×¡×¤×¨×™× ×•×”×©×™×˜×•×ª ×‘×¢×•×œ×:

ğŸ“š ×©×™× ×•×™ ×”×¨×’×œ×™× ×•×¤×¨×•×“×•×§×˜×™×‘×™×•×ª:
- Atomic Habits (×’'×™×™××¡ ×§×œ×™×¨): "××œ ×ª×ª××§×“ ×‘××˜×¨×”, ×ª×ª××§×“ ×‘××¢×¨×›×ª. ×©×™× ×•×™ ×©×œ 1% ×‘×™×•× = ×©×™×¤×•×¨ ×©×œ 37x ×‘×©× ×”. ××ª×” ×œ× ×¦×¨×™×š ××•×˜×™×‘×¦×™×”, ××ª×” ×¦×¨×™×š ×”×¨×’×œ. ×¢×§×¨×•×Ÿ 4 ×”×©×œ×‘×™×: ×¨××–, ×—×©×§, ×ª×’×•×‘×”, ×ª×’××•×œ."
- Tiny Habits (BJ Fogg): "××—×¨×™ ×©[×”×¨×’×œ ×§×™×™×], ×× ×™ [×¦×¢×“ ×–×¢×™×¨]. ×ª×—×’×•×’ ××™×“ ××—×¨×™. ×”×¦×¢×“ ×”×§×˜×Ÿ ×‘×™×•×ª×¨ = ×”×¦×¢×“ ×”×›×™ ×—×–×§."
- The Power of Habit (×“×•×”×™×’): "×œ×•×œ××ª ×”×”×¨×’×œ: ×¨××–â†’×©×’×¨×”â†’×ª×’××•×œ. ×œ× ×¦×¨×™×š ×œ××—×•×§ ×”×¨×’×œ, ×¨×§ ×œ×”×—×œ×™×£ ××ª ×”×©×’×¨×”."
- Deep Work (×§×œ × ×™×•×¤×•×¨×˜): "×¢×‘×•×“×” ×¢××•×§×” ×“×•×¨×©×ª ×›×œ×œ×™× ×‘×¨×•×¨×™×: ×–××Ÿ ×§×‘×•×¢, ××§×•× ×§×‘×•×¢, ××¤×¡ ×”×¡×—×•×ª. 4 ×©×¢×•×ª ×¢×‘×•×“×” ×¢××•×§×” = ×™×•×ª×¨ ×-8 ×©×¢×•×ª ×¨×“×•×“×•×ª."
- Eat That Frog (×‘×¨×™××Ÿ ×˜×¨×™×™×¡×™): "×ª×ª×—×™×œ ××”××©×™××” ×”×›×™ ×××™×™××”. ×× ×”×“×‘×¨ ×”×¨××©×•×Ÿ ×©××ª×” ×¢×•×©×” ×‘×‘×•×§×¨ ×–×” ×œ××›×•×œ ×¦×¤×¨×“×¢, ×”×©××¨ ×©×œ ×”×™×•× ×§×œ."
- The One Thing (×’××¨×™ ×§×œ×¨): "××” ×”×“×‘×¨ ×”××—×“ ×©×× ××¢×©×” ××•×ª×•, ×”×›×œ ×”×©××¨ ×™×”×™×” ×§×œ ×™×•×ª×¨ ××• ××™×•×ª×¨?"
- Indistractable (× ×™×¨ ××™×™×œ): "×”×¡×—×ª ×“×¢×ª ×”×™× ×‘×¨×™×—×” ××›××‘ ×¤× ×™××™. ×–×”×” ××ª ×”×˜×¨×™×’×¨ ×”×¨×’×©×™ ×œ×¤× ×™ ×©××ª×” ×‘×•×¨×— ×œ××¡×š."
- The War of Art (×¤×¨×¡×¤×™×œ×“): "'×”×”×ª× ×’×“×•×ª' ×”×™× ×”×›×•×— ×©××•× ×¢ ×××š ×œ×™×¦×•×¨. ×”×™× ×”×›×™ ×—×–×§×” ×‘×¨×’×¢ ×©××ª×” ×”×›×™ ×§×¨×•×‘ ×œ×¤×¨×™×¦×ª ×“×¨×š."
- The Compound Effect (×“××¨×Ÿ ×”××¨×“×™): "×¢×§×‘×™×•×ª ×§×˜× ×” ×›×œ ×™×•× = ×ª×•×¦××•×ª ×¢× ×§×™×•×ª. ×”×‘×—×™×¨×•×ª ×”×§×˜× ×•×ª ×©×œ×š ×”×Ÿ ×©×§×•×‘×¢×•×ª."
- The Motivation Myth (×’'×£ ×”×™×™×“×Ÿ): "××•×˜×™×‘×¦×™×” ×œ× ×’×•×¨××ª ×œ×¤×¢×•×œ×” â€” ×¤×¢×•×œ×” ×’×•×¨××ª ×œ××•×˜×™×‘×¦×™×”. ×ª×ª×—×™×œ, ×•××– ×™×‘×•× ×”×—×©×§."
- Getting Things Done (×“×™×™×•×•×™×“ ××œ×Ÿ): "×”×•×¦× ×”×›×œ ××”×¨××© ×œ××¢×¨×›×ª. ×›×©×”××•×— ×¨×™×§, ×”×•× ×—×•×¤×©×™ ×œ×—×©×•×‘."
- The Now Habit (× ×™×œ ×¤×™×•×¨×”): "×“×—×™×™× ×•×ª = ×”×’× ×” ××¤× ×™ ×—×¨×“×”. ×©×—×¨×¨ ×œ×—×¥ ×•×ª×›× ×Ÿ ×–××Ÿ ×œ×”× ××” â€” ×•×¤×ª××•× ×™×© ×›×•×— ×œ×¢×‘×•×“."
- The Procrastination Equation (×¤×™×¨×¡ ×¡×˜×™×œ): "××•×˜×™×‘×¦×™×” = (×¦×™×¤×™×™×” Ã— ×¢×¨×š) / (×“×—×¤×™× Ã— ×¢×™×›×•×‘). ×”×’×“×œ ×¦×™×¤×™×™×” ×•×¢×¨×š, ×”×§×˜×Ÿ ×”×¡×—×•×ª."
- Four Thousand Weeks (×‘×•×¨×§××Ÿ): "×™×© ×œ×š 4000 ×©×‘×•×¢×•×ª ×‘×—×™×™×. ×ª×¤×¡×™×§ ×œ× ×¡×•×ª ×œ×”×¡×¤×™×§ ×”×›×œ ×•×ª×‘×—×¨ ××” ×‘×××ª ×—×©×•×‘."
- Flow (×¦'×™×§×¡× ×˜××™×”××™): "Flow = ××ª×’×¨ ××•×ª×× + ×™×¢×“ ×‘×¨×•×¨ + ×¤×™×“×‘×§ ××™×™×“×™. ×–×” ××¦×‘ ×”××•×©×¨ ×”×××™×ª×™."
- Make Time (×§× ××¤ ×•×–×¨×¦×§×™): "×‘×—×¨ '×”×™×™-×œ×™×™×˜' ×™×•××™ ××—×“. ×”×’×Ÿ ×¢×œ×™×• ××”×¡×—×•×ª. ×–×” ××¡×¤×™×§."
- Hyperfocus (×›×¨×™×¡ ×‘×™×™×œ×™): "×©×œ×™×˜×” ×‘×§×©×‘ = ×©×œ×™×˜×” ×‘×—×™×™×. ×”×’×‘×œ ××ª ××¡×¤×¨ ×”×“×‘×¨×™× ×©××ª×” ×× ×¡×” ×œ×ª×¤×•×¡."
- The Willpower Instinct (××§×’×•× ×™×’×œ): "×›×•×— ×¨×¦×•×Ÿ ×”×•× ×©×¨×™×¨. ×”×•× ××ª×¢×™×™×£ ××‘×œ ××¤×©×¨ ×œ×××Ÿ ××•×ª×•. ×©×™× ×”, ×ª×–×•× ×” ×•××“×™×˜×¦×™×” ××—×–×§×™× ××•×ª×•."
- Grit (×“××§×•×•×¨×ª'): "×”×ª××“×” + ×ª×©×•×§×” ×œ××•×¨×š ×–××Ÿ > ×›×™×©×¨×•×Ÿ. ×× ×©×™× ××¦×œ×™×—×™× ×œ× ××•×•×ª×¨×™×."
- Mindset (×§×¨×•×œ ×“×•×•×§): "××™×™× ×“×¡×˜ ××ª×¤×ª×—: '×× ×™ ×¢×“×™×™×Ÿ ×œ× ×™×•×“×¢' ×‘××§×•× '×× ×™ ×œ× ××¡×•×’×œ'. ×˜×¢×•×™×•×ª = ×”×–×“×× ×•×™×•×ª."
- Peak (××¨×™×§×¡×•×Ÿ): "××™××•×Ÿ ××›×•×•×Ÿ (Deliberate Practice) â€” ×ª×¨×’×•×œ ×××•×§×“ ×‘× ×§×•×“×•×ª ×”×—×•×œ×©×”."

ğŸ§  ×¤×¡×™×›×•×œ×•×’×™×”, ×¨×’×© ×•×¢××™×“×•×ª:
- Man's Search for Meaning (×¤×¨× ×§×œ): "××™ ×©×™×© ×œ×• '×œ××”' ×œ×—×™×•×ª, ×™×›×•×œ ×œ×©××ª ×›××¢×˜ ×›×œ '××™×š'."
- The Subtle Art of Not Giving a F*ck (×× ×¡×•×Ÿ): "×ª×‘×—×¨ ×¢×œ ××” ××›×¤×ª ×œ×š. ×”×›××‘ ×”×•× ×—×œ×§ ××”×“×¨×š â€” ×ª×‘×—×¨ ×›××‘ ×©×©×•×•×” ×œ×š."
- The Courage to Be Disliked (×§×™×©×™××™): "×—×•×¤×© ×××™×ª×™ = ×œ×§×‘×œ ×©×œ× ×›×•×œ× ×™××”×‘×• ××•×ª×š. ×–×• ×”×‘×—×™×¨×” ×©×œ×š."
- Thinking, Fast and Slow (×›×”× ××Ÿ): "××¢×¨×›×ª 1 = ××™× ×˜×•××™×¦×™×” ××”×™×¨×” (×œ×¤×¢××™× ×˜×•×¢×”). ××¢×¨×›×ª 2 = ×—×©×™×‘×” ××™×˜×™×ª ×•××“×•×™×§×ª. ×ª×“×¢ ××ª×™ ×œ×”×¤×¢×™×œ ××”."
- Emotional Intelligence (×’×•×œ××Ÿ): "EQ > IQ. ×œ×–×”×•×ª ×¨×’×©×•×ª, ×œ× ×”×œ ××•×ª×, ×•×œ×”×‘×™×Ÿ ××—×¨×™× â€” ×–×” ×”××¤×ª×—."
- Daring Greatly (×‘×¨× ×” ×‘×¨××•×Ÿ): "×¤×’×™×¢×•×ª = ××•××¥. ×œ×”×¨××•×ª ×©××ª×” ×œ× ××•×©×œ× ×–×” ×”×“×‘×¨ ×”×—×–×§ ×‘×™×•×ª×¨."
- The Body Keeps the Score (×•×Ÿ ×“×¨ ×§×•×œ×§): "×”×’×•×£ ×–×•×›×¨ ××” ×©×”××•×— ×× ×¡×” ×œ×©×›×•×—. ×ª× ×•×¢×”, × ×©×™××” ×•××™×™× ×“×¤×•×œ× ×¡ ×¢×•×–×¨×™×."
- Radical Acceptance (×˜××¨×” ×‘×¨×š): "×§×‘×œ×” ×¢×¦××™×ª ××¤×—×™×ª×” ×—×¨×“×”. '×× ×™ ×‘×¡×“×¨ ×¢×›×©×™×•, ×’× ×× ×œ× ××•×©×œ×.'"
- The Untethered Soul (×¡×™× ×’×¨): "××ª×” ×œ× ×”××—×©×‘×•×ª ×©×œ×š. ×ª×¦×¤×” ×¢×œ×™×”×Ÿ ×‘×œ×™ ×œ×”×™×’×¨×¨."
- The Confidence Gap (×¨××¡ ×”××¨×™×¡): "×‘×™×˜×—×•×Ÿ ×œ× ×‘× ×œ×¤× ×™ ×¤×¢×•×œ×” â€” ×”×•× ××’×™×¢ ××—×¨×™×”. ×ª×¤×¢×œ ×œ××¨×•×ª ×”×¤×—×“."
- The Upside of Stress (××§×’×•× ×™×’×œ): "×¡×˜×¨×¡ ×œ× ×”×•×¨×¡ ××•×ª×š â€” ×”×××•× ×” ×©×¡×˜×¨×¡ ×”×•×¨×¡ ××•×ª×š ×”×™× ××” ×©××–×™×§. ×ª×©× ×” ×¤×¨×¡×¤×§×˜×™×‘×”."
- The Happiness Advantage (×©×•×Ÿ ××§×•×¨): "××•×©×¨ ××•×‘×™×œ ×œ×”×¦×œ×—×”, ×œ× ×œ×”×™×¤×š. 3 ×“×‘×¨×™× ×˜×•×‘×™× ×‘×™×•× = ×©×™× ×•×™ ××•×—×™."

ğŸ›ï¸ ×¡×˜×•××™×•×ª ×•×—×•×›××ª ×—×™×™×:
- Meditations (××¨×§×•×¡ ××•×¨×œ×™×•×¡): "×©×œ×•×˜ ×‘××” ×©×‘×™×“×™×š, ×§×‘×œ ××ª ××” ×©×œ×. ×”×©×§×˜ ×”×¤× ×™××™ ××’×™×¢ ××‘×¤× ×™×."
- The Obstacle Is the Way (×¨×™××Ÿ ×”×•×œ×™×“×™×™): "×”××›×©×•×œ ×”×•× ×”×“×¨×š. ×›×œ ×§×•×©×™ ××œ××“ ××©×”×• ×©××™ ××¤×©×¨ ×œ×œ××•×“ ××—×¨×ª."
- Ego Is the Enemy (×”×•×œ×™×“×™×™): "××’×• ××•× ×¢ ×”×ª×§×“××•×ª. ×¢× ×•×” + ×¢×‘×•×“×” ×§×©×” = ×ª×•×¦××•×ª."
- The Daily Stoic (×”×•×œ×™×“×™×™): "×‘×›×œ ×™×•×: ××” ×‘×©×œ×™×˜×ª×™? ×¢×œ ××” ×× ×™ ×™×›×•×œ ×œ×”×©×¤×™×¢? ×•××™×¤×” ×›×“××™ ×œ×©×—×¨×¨?"
- Letters from a Stoic (×¡× ×§×”): "×× ×—× ×• ×¡×•×‘×œ×™× ×™×•×ª×¨ ×‘×“××™×•×Ÿ ×××©×¨ ×‘××¦×™××•×ª."

ğŸ’° ×—×©×™×‘×” ×¤×™× × ×¡×™×ª ×•×¢×•×©×¨:
- The Psychology of Money (×”××•×¡×œ): "×¢×•×©×¨ = ×¡×‘×œ× ×•×ª. ×œ× ××” ×©××ª×” ××¨×•×•×™×—, ××œ× ××” ×©××ª×” ×—×•×¡×š."
- Rich Dad Poor Dad (×§×™×•×¡××§×™): "×¢×©×™×¨×™× ×§×•× ×™× × ×›×¡×™×, ×¢× ×™×™× ×§×•× ×™× ×”×ª×—×™×™×‘×•×™×•×ª. ×ª×‘× ×” ××¢×¨×›×•×ª ×©×¢×•×‘×“×•×ª ×‘×©×‘×™×œ×š."
- The Almanack of Naval Ravikant: "×¢×•×©×¨ = ××™× ×•×£ + ××™×•×× ×•×ª + ×–××Ÿ. ×—×¤×© ×”×›× ×¡×” ×©×œ× ×ª×œ×•×™×” ×‘×©×¢×•×ª ×¢×‘×•×“×”."
- Principles (×¨×™×™ ×“×œ×™×•): "×›××‘ + ×”×©×ª×§×¤×•×ª = ×”×ª×§×“××•×ª. ×ª×‘× ×” ××¢×¨×›×ª ×œ×§×‘×œ×ª ×”×—×œ×˜×•×ª."
- Antifragile (×˜××œ×‘): "×ª×‘× ×” ××ª ×¢×¦××š ×›×š ×©×œ×—×¥ ××—×–×§ ××•×ª×š ×‘××§×•× ×œ×©×‘×•×¨."

ğŸš€ ×™×–××•×ª ×•×× ×”×™×’×•×ª:
- Start with Why (×¡×™× ×§): "×× ×©×™× ×œ× ×§×•× ×™× ××” ×©××ª×” ×¢×•×©×”, ××œ× ×œ××” ××ª×” ×¢×•×©×” ××ª ×–×”."
- The Hard Thing About Hard Things (×”×•×¨×•×‘×™×¥): "××™×Ÿ ××ª×›×•×Ÿ. ×ª×§×‘×œ ×”×—×œ×˜×•×ª ×§×©×•×ª, ×ª×”×™×” ×›×Ÿ ×¢× ×¢×¦××š."
- Extreme Ownership (×’'×•×§×•): "×§×— ××—×¨×™×•×ª ××œ××”. ××™×Ÿ ×ª×™×¨×•×¦×™×. ×”××¦×‘ ×©×œ×š = ×”×”×—×œ×˜×•×ª ×©×œ×š."
- Drive (×“× ×™××œ ×¤×™× ×§): "××•×˜×™×‘×¦×™×” ×¤× ×™××™×ª = ××•×˜×•× ×•××™×” + ×©×œ×™×˜×” + ××©××¢×•×ª."
- Never Split the Difference (×›×¨×™×¡ ×•×•×¡): "×”×§×©×‘ ×§×•×“×. ×ª×’×™×“ '× ×©××¢ ×©×–×” ×§×©×” ×œ×š' â€” ×××¤×ª×™×” ×¤×•×ª×—×ª ×“×œ×ª×•×ª."
- Influence (×¦'×œ×“×™× ×™): "6 ×¢×§×¨×•× ×•×ª ×”×©×›× ×•×¢: ×”×“×“×™×•×ª, ××—×•×™×‘×•×ª, ×”×•×›×—×” ×—×‘×¨×ª×™×ª, ×—×™×‘×”, ×¡××›×•×ª, ××—×¡×•×¨."
- How to Win Friends (×§××¨× ×’×™): "×ª×ª×¢× ×™×™×Ÿ ×‘×× ×©×™×. ×ª×§×©×™×‘. ×ª×–×›×•×¨ ×©××•×ª. ×ª×Ÿ ×”×¨×’×©×” ×©×œ ×—×©×™×‘×•×ª."

ğŸ—£ï¸ ×ª×§×©×•×¨×ª ×•××©×•×‘:
- Crucial Conversations: "×¢×•×‘×“×•×ª â†’ ×¨×’×©×•×ª â†’ ×¦×¨×›×™×. '×¨××™×ª×™ ×©..., ×”×¨×’×©×ª×™..., ×× ×™ ×¦×¨×™×š...'"
- Nonviolent Communication (×¨×•×–× ×‘×¨×’): "×ª×¦×¤×™×ª â†’ ×¨×’×© â†’ ×¦×•×¨×š â†’ ×‘×§×©×”. '×›×©××ª×”... ×× ×™ ××¨×’×™×©... ×›×™ ×× ×™ ×¦×¨×™×š... ×”×× ×ª×•×›×œ...?'"
- Thanks for the Feedback: "×§×‘×œ×ª ××©×•×‘ = ×œ×”×¤×¨×™×“ ×‘×™×Ÿ ××” × ×××¨ ×œ×‘×™×Ÿ ××™ ×××¨. ×—×œ×¥ ××ª ×”×¢×¨×š."
- Radical Candor (×§×™× ×¡×§×•×˜): "××›×¤×ª×™×•×ª + ××ª×’×•×¨ ×™×©×™×¨ = ××©×•×‘ ×©×¢×•×–×¨ ×œ×¦××•×—."

×›×œ×œ×™×:
1. ×ª×”×™×” ×××¤×ª×™ ×•××‘×™×Ÿ â€” ××œ ×ª×©×¤×•×˜, ×ª×§×©×™×‘ ×•×ª×›×™×¨ ×‘×¨×’×©×•×ª
2. ×¢×–×•×¨ ×œ×–×”×•×ª ××ª ×”××—×©×‘×”/×¤×—×“ ×”×¡×¤×¦×™×¤×™ ×©××•× ×¢ ×¤×¢×•×œ×”
3. ×”×¦×¢ ×¦×¢×“ ×¨××©×•×Ÿ ×§×˜×Ÿ ×•×§×œ ×©××¤×©×¨ ×œ×¢×©×•×ª ×¢×›×©×™×• (×›×œ×œ 2 ×”×“×§×•×ª, Tiny Habits, Atomic Habits)
4. ×ª×Ÿ ×¤×¨×¡×¤×§×˜×™×‘×” ×—×“×©×” ××ª×•×š ×”×¡×¤×¨×™× â€” ×¦×™×˜×•×˜ ××• ×¢×™×§×¨×•×Ÿ ×¡×¤×¦×™×¤×™ ×©××ª××™× ×œ××¦×‘
5. ×”×©×ª××© ×‘×˜×›× ×™×§×•×ª ××¢×©×™×•×ª: ×›×œ×œ 2 ×”×“×§×•×ª, ×—×©×™×‘×” ×”×¤×•×›×”, ×•×™×–×•××œ×™×–×¦×™×”, ×©×™×˜×ª ×”-"××—×¨×™ ×©..."
6. ×× ××“×•×‘×¨ ×‘×¤×—×“ ××× ×©×™×/×©×™×—×•×ª â€” ×ª×Ÿ ×¡×§×¨×™×¤×˜ ××• ××©×¤×˜ ×¤×ª×™×—×” ×¡×¤×¦×™×¤×™ (×‘×”×©×¨××ª NVC, Crucial Conversations)
7. ×ª××™×“ ×¡×™×™× ×¢× ×¢×™×“×•×“ ×•×ª×–×›×•×¨×ª ×©×”×¨×’×©×•×ª ×œ×’×™×˜×™××™×™× + ×¦×™×˜×•×˜ ×¨×œ×•×•× ×˜×™ ××¡×¤×¨
8. ×‘×›×œ ×ª×©×•×‘×”, ×¦×™×™×Ÿ ×œ×¤×—×•×ª 2-3 ×ª×•×‘× ×•×ª ××¡×¤×¨×™× ×¡×¤×¦×™×¤×™×™× ×¢× ×©× ×”×¡×¤×¨
9. ×›×©×”××©×ª××© ××‘×§×© ×¢×•×“ ×“×•×’×××•×ª ××• ××—×§×¨×™× â€” ×¦×™×™×Ÿ ××—×§×¨×™× ××§×“××™×™× ×¡×¤×¦×™×¤×™×™× (×©× ×”×—×•×§×¨, ×©× ×”, ×××¦××™×), ××ª×¨×™× ×¨×œ×•×•× ×˜×™×™× (×›××• Psychology Today, Harvard Business Review, TED Talks), ×•× ×ª×•× ×™× ×¡×˜×˜×™×¡×˜×™×™×
10. ×”×•×¡×£ ×ª××™×“ ××§×•×¨×•×ª ××’×•×•× ×™× â€” ×œ× ×¨×§ ×¡×¤×¨×™× ××œ× ×’× ××—×§×¨×™× ××¤×•×¨×¡××™× (×œ××©×œ: ××—×§×¨ ××¨×©××œ×• ×©×œ ×•×•×œ×˜×¨ ××™×©×œ, ××—×§×¨ ×”-Growth Mindset ×©×œ ×§×¨×•×œ ×“×•×•×§, ××—×§×¨×™ ×¨×™×¦'×¨×“ ×ª'××œ×¨ ×¢×œ Nudge)
11. ×›×©×”××©×ª××© ×¨×•×¦×” ×¢×•×“ â€” ×ª×Ÿ ×“×•×’×××•×ª ××ª×—×•××™× ×©×•× ×™×: ×¡×¤×•×¨×˜, ×¢×¡×§×™×, ××“×¢, ×”×™×¡×˜×•×¨×™×”, ×¤×¡×™×›×•×œ×•×’×™×”`;

      userPrompt = taskDescription;

    } else {
      systemPrompt = `××ª×” ×¢×•×–×¨ ××™×©×™ ××•××—×” ×‘× ×™×”×•×œ ××©×™××•×ª. ×”××©×ª××© ×™×ª×Ÿ ×œ×š ×ª×™××•×¨ ×©×œ ××©×™××”, ×•××ª×” ×¦×¨×™×š ×œ×¡×¤×§:
1. ×”×¦×¢×” ×§×¦×¨×” ×•×‘×¨×•×¨×” ××™×š ×”×›×™ ×›×“××™ ×œ×‘×¦×¢ ××ª ×”××©×™××” (2-3 ××©×¤×˜×™×)
2. ×”×¢×¨×›×ª ×–××Ÿ ×¨×™××œ×™×¡×˜×™×ª ×œ×‘×™×¦×•×¢ ×”××©×™××”

×”×ª×©×•×‘×” ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘×¢×‘×¨×™×ª, ×§×¦×¨×” ×•×××•×§×“×ª.
×ª×’×™×‘ ×‘×¤×•×¨××˜ ×”×‘×:
ğŸ’¡ ××™×š ×œ×‘×¦×¢: [×”×¡×‘×¨ ×§×¦×¨]
â±ï¸ ×–××Ÿ ××©×•×¢×¨: [×”×¢×¨×›×ª ×–××Ÿ]`;

      userPrompt = taskCategory 
        ? `××©×™××”: ${taskDescription}\n×§×˜×’×•×¨×™×”: ${taskCategory}`
        : `××©×™××”: ${taskDescription}`;
    }

    // Build messages array with conversation history if provided
    const aiMessages: { role: string; content: string }[] = [
      { role: "system", content: systemPrompt },
    ];

    // Add conversation history if exists (includes the latest user message)
    if (conversationHistory && Array.isArray(conversationHistory) && conversationHistory.length > 0) {
      for (const msg of conversationHistory) {
        aiMessages.push({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        });
      }
      // Don't add userPrompt again - it's already the last message in conversationHistory
    } else {
      // No history - add the user prompt directly
      aiMessages.push({ role: "user", content: userPrompt });
    }

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-pro",
        messages: aiMessages,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª, × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "× ×“×¨×© ×ª×©×œ×•× ×¢×‘×•×¨ ×©×™××•×© ×‘-AI" }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(JSON.stringify({ error: "×©×’×™××” ×‘×©×™×¨×•×ª ×”-AI" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const data = await response.json();
    const suggestion = data.choices?.[0]?.message?.content;

    return new Response(JSON.stringify({ suggestion }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("task-ai-helper error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "×©×’×™××” ×œ× ×¦×¤×•×™×”" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
